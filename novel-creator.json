{
  "id": "novel-creator",
  "name": "小说创作大师",
  "description": "完整的小说创作工作流系统，集成文件级长期记忆（Smart State模式），支持百万字级长篇小说。通过三核心文件+五追踪器+滚动压缩摘要+风格锚点，确保第200万字仍记得第1章的内容。",
  "version": "5.1.0",
  "features": [
    "拆书分析", "仿写学习", "知识库构建", "内容生成",
    "校稿编辑", "去AI化", "文件级长期记忆", "Smart State模式",
    "滚动压缩摘要", "一致性审计", "伏笔追踪", "会话恢复",
    "风格锚点", "对话画像", "情感节奏追踪", "批量写作",
    "章节修订", "章末钩子追踪", "风格校准"
  ],

  "activation": {
    "patterns": [
      "拆书", "仿写", "小说创作", "生成大纲", "生成人设",
      "世界观构建", "金手指设计", "黄金开篇", "小说知识库",
      "/novel-create", "/novel-analyze", "/拆书", "/仿写",
      "/建库", "/写作", "/续写", "/批量写作", "/修改章节",
      "/更新记忆", "/检查一致性", "/检索记忆", "/伏笔状态",
      "/角色状态", "/时间线", "/风格校准", "/校稿", "/完整流程"
    ],
    "triggers": [
      "用户要求拆解小说",
      "用户要求仿写小说",
      "用户需要生成小说元素",
      "用户需要构建小说知识库",
      "用户需要创作小说",
      "用户需要继续写作（续写）",
      "用户需要批量写作多章",
      "用户需要修改已写章节",
      "用户需要更新记忆",
      "用户需要检查一致性",
      "用户需要风格校准",
      "用户需要查看伏笔/角色/时间线状态"
    ]
  },

  "memory_system": {
    "name": "文件级长期记忆系统（Smart State模式）",
    "principle": "上下文窗口=内存（易失）；文件系统=磁盘（持久）",
    "reference": "https://github.com/OthmanAdi/planning-with-files",
    "smart_state": {
      "description": "novel_state.md 为唯一必读状态文件，内含各追踪器关键摘要",
      "benefit": "Pre-Write仅需读取2个文件（plan+state），减少70%读取量",
      "content_includes": ["进度", "活跃剧情线", "活跃人物摘要", "待回收伏笔", "最近5章摘要", "情感节奏快照", "风格提醒", "下一章预告"]
    },

    "core_files": {
      "novel_plan": {
        "path": "00_memory/novel_plan.md",
        "role": "主线计划（防止剧情偏离）",
        "access": "写前必读",
        "modify_rule": "仅在用户明确同意后修改"
      },
      "novel_state": {
        "path": "00_memory/novel_state.md",
        "role": "Smart State 核心状态文件（唯一必读状态）",
        "access": "写前必读，写后必更新（全量）",
        "content": ["进度", "活跃剧情线", "活跃人物摘要", "待回收伏笔", "最近5章摘要", "情感节奏快照", "风格提醒", "下一章预告"]
      },
      "novel_findings": {
        "path": "00_memory/novel_findings.md",
        "role": "发现与修正记录",
        "access": "会话恢复时读取，发现问题时写入"
      }
    },

    "trackers": {
      "character_tracker": {
        "path": "00_memory/character_tracker.md",
        "role": "全角色完整档案",
        "access": "按需读取（复杂角色互动时）"
      },
      "timeline": {
        "path": "00_memory/timeline.md",
        "role": "时间线事件表",
        "access": "按需读取（时间跳跃时）"
      },
      "foreshadowing_tracker": {
        "path": "00_memory/foreshadowing_tracker.md",
        "role": "伏笔追踪器",
        "access": "按需读取（回收伏笔时）"
      },
      "world_state": {
        "path": "00_memory/world_state.md",
        "role": "世界/势力/力量体系状态",
        "access": "按需读取（新地点/势力出现时）"
      },
      "style_anchor": {
        "path": "00_memory/style_anchor.md",
        "role": "风格锚点（风格DNA+对话画像+情感节奏+禁忌清单）",
        "access": "按需读取（重要场景时）；每10章强制校准"
      }
    },

    "chapter_summaries": {
      "path": "00_memory/chapter_summaries/",
      "compression_strategy": "滚动压缩",
      "levels": {
        "L1_detailed": {
          "range": "最近10章",
          "words_per_chapter": "300-500字",
          "file": "recent.md"
        },
        "L2_medium": {
          "range": "11-50章前",
          "words_per_chapter": "100-200字",
          "file": "mid_term.md"
        },
        "L3_compressed": {
          "range": "50章前",
          "words_per_volume": "1000字",
          "file": "archive/volXX_XXX-XXX.md"
        }
      },
      "compression_triggers": {
        "every_1_chapter": "生成L1摘要追加到recent.md",
        "every_10_chapters": "recent.md最早章节压缩为L2移入mid_term.md",
        "every_50_chapters": "mid_term.md最早40章压缩为L3卷级总结移入archive/"
      }
    }
  },

  "hooks": {
    "pre_write": {
      "name": "Pre-Write Protocol (Smart State)",
      "trigger": "每次写新章节之前",
      "mandatory": true,
      "mandatory_reads": [
        {"action": "Read novel_plan.md", "purpose": "确认主线方向"},
        {"action": "Read novel_state.md", "purpose": "Smart State一站式状态"}
      ],
      "on_demand_reads": [
        {"condition": "涉及复杂角色互动", "action": "Read character_tracker.md"},
        {"condition": "涉及时间跳跃", "action": "Read timeline.md"},
        {"condition": "需回收伏笔", "action": "Read foreshadowing_tracker.md"},
        {"condition": "涉及新地点/势力", "action": "Read world_state.md"},
        {"condition": "重要战斗/情感场景", "action": "Read style_anchor.md"},
        {"condition": "需要更多上下文", "action": "Read chapter_summaries/recent.md"},
        {"condition": "涉及具体设定", "action": "Read 知识库相关文件"}
      ],
      "output": "写前检查清单（进度/计划/人物/伏笔/节奏/章末钩子/一致性）"
    },

    "post_write": {
      "name": "Post-Write Protocol",
      "trigger": "每章写完之后",
      "mandatory": true,
      "steps": [
        {"order": 1, "action": "提取本章核心记忆", "purpose": "结构化摘要"},
        {"order": 2, "action": "全量更新 novel_state.md", "purpose": "Smart State推进"},
        {"order": 3, "action": "更新受影响的追踪器", "purpose": "按需更新", "parallel": true},
        {"order": 4, "action": "追加 chapter_summaries/recent.md", "purpose": "L1摘要"},
        {"order": 5, "action": "一致性检查", "purpose": "记录到findings.md"},
        {"order": 6, "action": "更新 novel_plan.md checkbox", "purpose": "进度追踪"}
      ],
      "output": "写后更新报告（字数/章末钩子/情感基调/伏笔/一致性）"
    },

    "two_chapter_rule": {
      "name": "2-Chapter Rule",
      "trigger": "每写完2章",
      "mandatory": true,
      "checks": [
        "角色行为一致性 vs character_tracker.md",
        "设定一致性 vs world_state.md",
        "伏笔超期检查 vs foreshadowing_tracker.md",
        "主线偏离检查 vs novel_plan.md",
        "风格偏离检查 vs style_anchor.md"
      ],
      "output": "审计报告 → novel_findings.md"
    },

    "session_recovery": {
      "name": "Session Recovery",
      "trigger": "/续写 或新会话检测到记忆文件",
      "steps": [
        "读取 novel_plan.md",
        "读取 novel_state.md（Smart State一站式恢复）",
        "读取 novel_findings.md"
      ],
      "output": "恢复报告（小说名/进度/上章摘要/待回收伏笔/注意事项）"
    },

    "style_calibration": {
      "name": "Style Calibration",
      "trigger": "每写完10章 或 /风格校准",
      "steps": [
        "对比最近10章与style_anchor.md风格DNA",
        "检查禁忌清单违规",
        "检查角色对话画像一致性",
        "检查情感节奏是否平衡"
      ],
      "output": "风格校准报告"
    }
  },

  "consistency_engine": {
    "name": "一致性检测引擎",
    "dimensions": {
      "character": {
        "personality": "性格一致性",
        "ability": "能力一致性（不能使用已失去的能力）",
        "relationship": "关系一致性",
        "location": "位置一致性",
        "dialogue": "对话风格一致性（对照对话画像）"
      },
      "setting": {
        "worldview": "世界观一致性",
        "power_system": "力量体系一致性",
        "faction": "势力分布一致性",
        "geography": "地理一致性"
      },
      "plot": {
        "timeline": "时间线一致性",
        "causality": "因果逻辑一致性",
        "foreshadowing": "伏笔回收一致性",
        "main_plot": "主线方向一致性",
        "chapter_hook": "章末钩子→下章回应一致性"
      },
      "style": {
        "tone": "语气风格一致性",
        "rhythm": "节奏平衡性",
        "anti_ai": "去AI化合规性"
      }
    },
    "deviation_handling": {
      "on_conflict": [
        "1. 向用户发出警告",
        "2. 提供修正建议（推荐方案）",
        "3. 提供绕行方案（添加解释情节）",
        "4. 允许忽略（记录到findings.md）"
      ]
    }
  },

  "modules": {
    "analyzer": {
      "name": "拆书分析器",
      "command": "/拆书",
      "description": "深度拆解小说，提取金手指、爽点、人设、开篇四大维度"
    },
    "imitator": {
      "name": "仿写学习器",
      "command": "/仿写",
      "description": "提取写作模板和技巧 + 风格DNA写入style_anchor.md"
    },
    "knowledge_base_builder": {
      "name": "知识库构建器",
      "command": "/建库",
      "description": "生成12个知识库模块 + 初始化全部记忆文件（含style_anchor）",
      "memory_init": [
        "从大纲生成 novel_plan.md",
        "初始化 novel_state.md（Smart State）",
        "初始化 novel_findings.md",
        "从人物库生成 character_tracker.md",
        "初始化 timeline.md",
        "初始化 foreshadowing_tracker.md",
        "从世界观库生成 world_state.md",
        "从仿写分析初始化 style_anchor.md",
        "创建 chapter_summaries/ 目录"
      ]
    },
    "generator": {
      "name": "内容生成器",
      "command": "/写作",
      "description": "生成章节，执行Smart State Pre/Post-Write Protocol",
      "protocol": ["pre_write", "generate", "post_write"]
    },
    "resume": {
      "name": "续写恢复器",
      "command": "/续写",
      "description": "会话恢复+继续写下一章",
      "protocol": ["session_recovery", "pre_write", "generate", "post_write"]
    },
    "batch_writer": {
      "name": "批量写作器",
      "command": "/批量写作",
      "description": "连续生成多章，自动循环Pre-Write→生成→Post-Write",
      "protocol": ["for_each: pre_write→generate→post_write", "compression_check", "two_chapter_rule_check"]
    },
    "chapter_reviser": {
      "name": "章节修订器",
      "command": "/修改章节",
      "description": "修改已写章节+级联更新所有受影响的记忆文件",
      "steps": ["读取原章节", "用户修改指令", "生成修改版", "Diff对比", "级联更新记忆", "影响报告"]
    },
    "memory_updater": {
      "name": "记忆更新器",
      "command": "/更新记忆",
      "description": "手动触发全面记忆更新和一致性审计"
    },
    "consistency_checker": {
      "name": "一致性审计器",
      "command": "/检查一致性",
      "description": "全面检查剧情/人物/设定/风格一致性"
    },
    "memory_searcher": {
      "name": "记忆检索器",
      "command": "/检索记忆",
      "description": "按关键词搜索所有记忆文件"
    },
    "foreshadowing_report": {
      "name": "伏笔报告器",
      "command": "/伏笔状态",
      "description": "查看所有伏笔的当前状态"
    },
    "character_report": {
      "name": "角色报告器",
      "command": "/角色状态",
      "description": "查看所有角色的当前状态"
    },
    "timeline_report": {
      "name": "时间线报告器",
      "command": "/时间线",
      "description": "查看完整时间线"
    },
    "style_calibrator": {
      "name": "风格校准器",
      "command": "/风格校准",
      "description": "对比当前写作与风格锚点，检查偏离并给出修正建议"
    },
    "editor": {
      "name": "校稿编辑器",
      "command": "/校稿",
      "description": "专业校稿和去AI化润色（含风格一致性检查）",
      "modes": ["全面", "快速", "去AI", "精修"]
    }
  },

  "workflow": {
    "stages": [
      {"id": "stage1_analyze", "name": "拆书学习", "command": "/拆书"},
      {"id": "stage2_imitate", "name": "仿写学习+风格提取", "command": "/仿写"},
      {"id": "stage3_knowledge", "name": "知识库构建+记忆初始化", "command": "/建库"},
      {"id": "stage4_generate", "name": "章节生成（Smart State协议）", "command": "/写作"},
      {"id": "stage4b_batch", "name": "批量生成", "command": "/批量写作"},
      {"id": "stage5_revise", "name": "章节修订", "command": "/修改章节"},
      {"id": "stage6_update", "name": "记忆更新", "command": "/更新记忆"},
      {"id": "stage7_calibrate", "name": "风格校准", "command": "/风格校准"},
      {"id": "stage8_edit", "name": "校稿编辑", "command": "/校稿"}
    ]
  },

  "output": {
    "directory_structure": {
      "root": "novel_project_{name}",
      "subdirectories": [
        {"name": "00_memory", "description": "长期记忆系统", "files": [
          "novel_plan.md", "novel_state.md", "novel_findings.md",
          "character_tracker.md", "timeline.md", "foreshadowing_tracker.md",
          "world_state.md", "style_anchor.md", "chapter_summaries/"
        ]},
        {"name": "01_analysis", "description": "拆书分析报告"},
        {"name": "02_knowledge_base", "description": "12个知识库模块"},
        {"name": "03_manuscript", "description": "正文章节"},
        {"name": "04_editing", "description": "校稿记录"},
        {"name": "05_assets", "description": "辅助资源"}
      ]
    }
  },

  "mcp_integration": {
    "sequential": "复杂剧情逻辑分析、一致性推理、审计",
    "context7": "查询写作技巧、文学理论",
    "tavily": "查找参考资料、对标作品信息"
  }
}

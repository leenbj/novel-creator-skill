---
name: novel-creator-skill
description: 用于中文小说全流程创作。将模糊剧情思路推进为百万字级长篇路线图，在低上下文开销下执行章节写作，并通过强制质量门禁（更新记忆→一致性检查→风格校准→校稿→门禁检查）确保每章可发布，支持样章风格提取、跨项目风格复用与题材风格引导。
---

# 小说创作技能（新手优先完整说明版 v7.2）

## 更新说明（v7.2）
- `/剧情检索` 升级为两级检索（粗筛 + 精排），默认降低检索上下文开销。
- 新增章节 sidecar 元数据：`00_memory/retrieval/chapter_meta/*.meta.json`。
- `/继续写` 新增执行锁、幂等缓存、写前快照、失败回滚（可配置）。
- 门禁新增质量基线硬校验（`quality_report` 必须通过）并支持自动最小修复 + 二次复检。
- 新增基线评测脚本：`scripts/benchmark_novel_flow.py`，输出可量化指标。

## 更新说明（v7.1）
- 修复 `/继续写` 占位章误判：正文中偶发“待写”文本不再被误判为草稿。
- 优化自动成稿上下文清洗：检索摘要会自动去除占位标记，降低脏上下文污染。
- 补齐端到端回归验证：`scripts/test_novel_flow_executor.py` 三项测试全部通过。

## 更新说明（v7.0）
- 新增新手三命令流程：`/一键开书`、`/继续写`、`/修复本章`。
- 新增 `/新手模式`：默认开启时优先使用最简流程，隐藏复杂参数。
- 保留全部原有命令；高级用户可继续使用完整链路。
- 检索继续采用：条件触发 + 片段级召回 + 查询缓存 + 增量索引。

## 1. 核心目标
- 更少上下文开销完成长篇稳定写作。
- 保留全部原有命令能力。
- 将每章质量门禁从“文本约束”升级为“脚本硬校验”。
- 用章节级检索（RAG 风格）提升长期一致性，降低百万字写作跑偏概率。

## 2. 强制章节闭环（不可跳过）
每次生成新章节后，固定执行：
1. `/更新记忆`
2. `/检查一致性`
3. `/风格校准`
4. `/校稿`
5. `/门禁检查`

门禁规则：`/门禁检查` 未通过，章节只能是草稿，禁止进入下一章。

## 3. 低上下文策略
- 写前默认只读：`00_memory/novel_plan.md`、`00_memory/novel_state.md`。
- 新剧情优先执行 `/剧情检索`，只读取 `00_memory/retrieval/next_plot_context.md` 推荐的 Top 章节。
- 单章前置读取上限：最多 4 个文件。
- 扩展追踪器按需读取，不全量加载。
- 每10章做一次深度压缩与深度风格校准。

## 4. 三种工作模式
1. 从模糊想法开书：`/写全篇` → `/建库` → `/更新剧情索引` → `/剧情检索` → `/写作` → 章节闭环。
2. 从样章仿写开书：`/仿写` → `/风格提取` → `/题材选风格` → `/剧情检索` → `/写作` → 章节闭环。
3. 已有项目续写：`/续写` → `/剧情检索` → `/写作` 或 `/批量写作` → 章节闭环。

## 4.1 新手最简单流程（推荐）
日常只记 3 条命令：
1. `/一键开书`：输入题材与剧情种子，自动完成开书与首章准备。
2. `/继续写`：自动执行“检索→写作→门禁→索引更新”全链路。
3. `/修复本章`：门禁失败时自动生成最短修复步骤并引导重跑。

新手模式建议：
- 开启：`/新手模式 开启`（默认）
- 关闭：`/新手模式 关闭`（切回高级流程）

## 5. 使用详细教程（一步一步）
### 教程 0：新手 3 步上手（最快）
步骤 1：开新书  
- 执行：`/一键开书`  
- 输入：题材、剧情种子、主角目标、核心冲突、预期篇幅。  
- 输出：项目结构、路线图、首章任务。

步骤 2：每天推进  
- 执行：`/继续写`  
- 系统自动执行：`/剧情检索`（条件触发）→ `/写作` → `/更新记忆` → `/检查一致性` → `/风格校准` → `/校稿` → `/门禁检查` → `/更新剧情索引`。  
- 输出：可发布章节或明确失败原因。

步骤 3：失败即修  
- 执行：`/修复本章`  
- 系统自动读取 `gate_result.json`，生成 `repair_plan.md` 并给出最短修复链路。

### 教程 A：从模糊想法到第一章发布稿
步骤 1：开书建模  
- 执行：`/写全篇`  
- 你需要提供：题材、剧情种子、主角目标、核心冲突、预期篇幅。  
- 预期产物：`idea_seed.md`、`million_word_blueprint.md`、`novel_plan.md`、`novel_state.md`。

步骤 2：初始化知识库  
- 执行：`/建库`  
- 预期产物：`00_memory/`、`02_knowledge_base/`、`03_manuscript/` 基础结构与初始化文件。

步骤 3：写前剧情检索  
- 执行：`/剧情检索`（可附带 `--auto-build`）  
- 你需要提供：本章准备写的新剧情描述。  
- 预期产物：`00_memory/retrieval/next_plot_context.md`（建议回读章节清单）。

步骤 4：生成章节草稿  
- 执行：`/写作`  
- 你需要提供：本章目标、冲突、人物、上章结尾（第一章可省略上章结尾）。  
- 预期产物：章节草稿文件（必须在 `03_manuscript/` 且为 `.md`）。

步骤 5：执行强制门禁  
- 依次执行：`/更新记忆` → `/检查一致性` → `/风格校准` → `/校稿` → `/门禁检查`  
- 预期产物目录：`04_editing/gate_artifacts/<chapter_id>/`  
- 必需文件：`memory_update.md`、`consistency_report.md`、`style_calibration.md`、`copyedit_report.md`、`publish_ready.md`、`gate_result.json`

步骤 6：更新剧情索引  
- 执行：`/更新剧情索引`  
- 预期产物：`story_index.json`、`entity_chapter_map.json`。

步骤 7：通过判定  
- 判定条件：`gate_result.json` 中 `passed=true`。  
- 若失败：按失败项回退修订，重新执行门禁链路。

### 教程 B：给样章，按原作者风格续写
步骤 1：风格学习  
- 执行：`/仿写`（提取写法框架）  
- 再执行：`/风格提取`（落地风格档案）

步骤 2：风格定位  
- 执行：`/题材选风格`  
- 目的：确定“题材基线风格 + 样章风格修正项”。

步骤 3：生成章节并过门禁  
- 执行：`/剧情检索` → `/写作` 或 `/续写`  
- 然后固定执行：`/更新记忆` → `/检查一致性` → `/风格校准` → `/校稿` → `/门禁检查`

### 教程 C：已有项目持续批量推进
步骤 1：恢复状态  
- 执行：`/续写`

步骤 2：批量推进  
- 执行：`/批量写作`（给出目标章数与每章任务点，每章写前自动触发 `/剧情检索`）

步骤 3：逐章门禁  
- 每一章都必须完成：`/更新记忆` → `/检查一致性` → `/风格校准` → `/校稿` → `/门禁检查`

步骤 4：周期维护  
- 每 10 章执行一次深度压缩与深度风格校准，控制上下文体积并抑制风格漂移。

## 6. 校验脚本（解决残余风险）
执行 `/门禁检查` 时运行：

```bash
python3 scripts/chapter_gate_check.py \
  --project-root <小说项目目录> \
  --chapter-file <章节文件>
```

脚本会校验 `04_editing/gate_artifacts/<chapter_id>/` 下的门禁产物完整性、非空性、时间顺序和发布关键词。

执行 `/更新剧情索引` 与 `/剧情检索` 时运行：

```bash
python3 scripts/plot_rag_retriever.py build --project-root <小说项目目录>
python3 scripts/plot_rag_retriever.py query --project-root <小说项目目录> --query "<新剧情>" --top-k 4 --candidate-k 12 --auto-build
```

脚本会在 `00_memory/retrieval/` 下生成索引与写前上下文建议文件；`build` 默认是增量构建，只重算变更章节。  
`query` 默认启用条件触发（轻场景跳过）、两级检索（粗筛+精排）、片段级召回和查询缓存；可用 `--force` 强制检索。  
同时生成章节元数据侧车文件：`00_memory/retrieval/chapter_meta/*.meta.json`。

执行 `/修复本章` 时运行：

```bash
python3 scripts/gate_repair_plan.py \
  --project-root <小说项目目录> \
  --chapter-file <章节文件>
```

脚本会读取 `04_editing/gate_artifacts/<chapter_id>/gate_result.json`，生成 `repair_plan.md` 并输出最短修复步骤。

执行 `/一键开书` 与 `/继续写` 的真实执行器：

```bash
python3 scripts/novel_flow_executor.py one-click --project-root <项目目录> --title <书名> --genre <题材> --idea <剧情种子>
python3 scripts/novel_flow_executor.py continue-write --project-root <项目目录> --query "<新剧情>"
python3 scripts/novel_flow_executor.py continue-write --project-root <项目目录> --query "<新剧情>" --candidate-k 12 --max-auto-retry-rounds 2 --rollback-on-failure --idempotent-cache
```

说明：
- `one-click` 会真正创建项目目录、初始化记忆文件、创建首章草稿、构建检索索引。
- `continue-write` 会真正执行检索与章节流程联动；若章节已成稿会触发门禁并在失败时联动修复计划。
- `continue-write` 默认启用执行锁、幂等缓存、写前快照与失败回滚；可用 `--force-run` 跳过幂等缓存。

执行流程基线评测：

```bash
python3 scripts/benchmark_novel_flow.py --project-root <小说项目目录> --rounds 5
```

评测结果会写入：`00_memory/retrieval/eval_baseline.json`。

## 7. 详细说明按需读取
- 命令手册：`references/command-playbook.md`
- 门禁产物规范：`references/gate-artifacts-spec.md`
- 百万字路线图：`references/million-word-roadmap.md`
- 题材风格矩阵：`references/genre-style-matrix.md`

默认不加载全部 reference，仅按当前任务读取。

## 8. 保留命令（全部有效）
`/拆书`、`/仿写`、`/建库`、`/写作`、`/续写`、`/批量写作`、`/修改章节`、`/更新记忆`、`/检查一致性`、`/风格校准`、`/校稿`

新增命令：`/门禁检查`、`/更新剧情索引`、`/剧情检索`、`/一键开书`、`/继续写`、`/修复本章`、`/新手模式`

运维命令（脚本入口）：`/评测基线`

## 9. 命令功能与使用说明（完整）
`/写全篇`
- 功能：将模糊剧情思路拆解为可执行的百万字路线图。
- 何时使用：开新书或旧大纲失效重建。
- 输入：题材、剧情种子、主角目标、核心冲突、预期篇幅。
- 输出：`idea_seed.md`、`million_word_blueprint.md`、`novel_plan.md`、`novel_state.md`。

`/一键开书`
- 功能：新手入口，一次完成“开书建模 + 建库 + 首章写作准备”。
- 何时使用：第一次开项目，或希望跳过复杂命令编排。
- 输入：题材、剧情种子、主角目标、核心冲突、预期篇幅。
- 输出：项目目录初始化完成 + 首章任务清单（可直接 `/继续写`）。
- 执行器：`python3 scripts/novel_flow_executor.py one-click --project-root <项目目录> --title <书名> --genre <题材> --idea <剧情种子>`。

`/继续写`
- 功能：新手日常唯一主命令，自动串行完整章节流程。
- 何时使用：日常推进章节时默认使用。
- 输入：本章目标（可选），冲突（可选），角色（可选）。
- 自动流程：`/剧情检索`（条件触发）→ `/写作` → `/更新记忆` → `/检查一致性` → `/风格校准` → `/校稿` → `/门禁检查` → `/更新剧情索引`。
- 输出：章节发布稿或失败报告。
- 执行器：`python3 scripts/novel_flow_executor.py continue-write --project-root <项目目录> --query "<新剧情>"`。

`/修复本章`
- 功能：针对门禁失败章节自动生成最短修复路径。
- 何时使用：`/门禁检查` 返回失败后。
- 输入：项目目录、章节文件。
- 输出：`04_editing/gate_artifacts/<chapter_id>/repair_plan.md`。

`/新手模式`
- 功能：切换简化交互层。
- 何时使用：新手开启，熟练后可关闭。
- 输入：`开启` 或 `关闭`。
- 输出：模式切换确认与推荐命令集。

`/更新剧情索引`
- 功能：扫描 `03_manuscript/*.md` 建立章节索引与角色-章节映射。
- 何时使用：新章通过门禁后、批量写作中、检索命中偏低时。
- 输入：项目目录。
- 输出：`00_memory/retrieval/story_index.json`、`entity_chapter_map.json`（默认增量更新，可选全量重建）。

`/剧情检索`
- 功能：按“新剧情描述”检索最相关章节与角色关系片段（RAG 风格）。
- 何时使用：每章写前；遇到新冲突、角色关系变化、回收伏笔时。
- 输入：新剧情描述（建议包含人物名、冲突、目标）。
- 输出：`00_memory/retrieval/next_plot_context.md`（默认返回关键片段而非整章，减少 token 消耗）。
- 机制：默认条件触发 + 查询缓存 + 两级检索（粗筛+精排）；可用 `--force`、`--no-cache`、`--no-conditional` 覆盖默认策略。
- 补充产物：`00_memory/retrieval/chapter_meta/*.meta.json`（章节元数据侧车文件）。

`/评测基线`（脚本入口）
- 功能：批量运行流程并输出可量化指标，形成优化对照基线。
- 何时使用：调参后验收、版本升级前后对比。
- 执行：`python3 scripts/benchmark_novel_flow.py --project-root <项目目录> --rounds 5`
- 输出：`00_memory/retrieval/eval_baseline.json`（ok_rate、gate_pass_rate、retry_rate、avg_runtime_ms、avg_retrieval_context_chars 等）。

`/拆书`
- 功能：拆解对标作品结构，提炼爽点与钩子机制。
- 何时使用：需要学习目标作品结构打法。
- 输入：目标作品文本或关键信息。
- 输出：结构分析报告（题材框架/爽点链路/人设机制/开篇钩子）。

`/仿写`
- 功能：提取可复用写法模板与风格特征。
- 何时使用：需要模仿已有样章文风。
- 输入：样章文本（建议不少于2章）。
- 输出：仿写模板、风格摘要、可迁移写作动作。

`/建库`
- 功能：初始化小说工程知识库与记忆系统。
- 何时使用：开书阶段或项目缺少基础记忆文件。
- 输入：项目名、题材、核心设定。
- 输出：`00_memory/`、`02_knowledge_base/`、`03_manuscript/` 初始化结果。

`/写作`
- 功能：生成单章草稿并触发质量闭环。
- 何时使用：推进下一章正文。
- 输入：章节目标、冲突、角色、上章结尾。
- 输出：`03_manuscript/*.md` 章节草稿 + 进入门禁流程。

`/续写`
- 功能：恢复会话状态并继续下一章。
- 何时使用：中断后继续项目。
- 输入：项目目录。
- 输出：恢复报告 + 新章草稿 + 门禁流程执行结果。

`/批量写作`
- 功能：连续生成多章并维持流程一致性。
- 何时使用：需要快速推进多个章节。
- 输入：目标章数、每章任务点。
- 输出：多章草稿；每章都执行强制门禁。

`/修改章节`
- 功能：对已写章节修订并级联更新记忆。
- 何时使用：章节返工、补设定、修逻辑。
- 输入：目标章节、修改要求。
- 输出：修订稿、影响面报告、记忆联动更新。

`/更新记忆`
- 功能：同步章节变化到状态与追踪器。
- 何时使用：每章生成后第一步，强制执行。
- 输入：本章正文。
- 输出：`novel_state.md`/追踪器/摘要增量更新 + `memory_update.md`。

`/检查一致性`
- 功能：检查剧情、设定、角色、时间线冲突。
- 何时使用：每章门禁第二步，强制执行。
- 输入：本章正文 + 当前记忆文件。
- 输出：一致性问题清单 + 修正建议 + `consistency_report.md`。

`/风格校准`
- 功能：检测并修正文风偏移。
- 何时使用：每章门禁第三步，强制执行（每10章深度校准）。
- 输入：本章正文 + `style_anchor.md`。
- 输出：风格偏移分析 + 修正建议 + `style_calibration.md`。

`/校稿`
- 功能：章节去AI味润色与发布前编辑。
- 何时使用：每章门禁第四步，强制执行。
- 输入：经校准后的章节稿。
- 输出：发布稿 + `copyedit_report.md` + `publish_ready.md`。

`/门禁检查`
- 功能：脚本化校验章节是否达到发布标准。
- 何时使用：每章门禁最后一步，强制执行。
- 输入：项目目录、章节文件。
- 输出：`gate_result.json`（`passed=true` 才可进入下一章；同时校验章节存储策略与目录隔离）。

`/题材选风格`
- 功能：按题材矩阵选择基线风格并结合项目修正。
- 何时使用：开书定风格或文风漂移后重定。
- 输入：题材、目标读者、节奏偏好。
- 输出：题材基线风格 + 项目修正建议。

`/风格提取`
- 功能：从样章提取风格并沉淀到项目与全局风格库。
- 何时使用：用户提供样章并要求“按该风格写”。
- 输入：风格名、项目目录、样章文件。
- 输出：风格档案、风格锚点更新、全局风格索引更新。

`/风格迁移`
- 功能：将指定风格档案应用到章节草稿。
- 何时使用：章节风格不统一或切换目标文风。
- 输入：章节草稿、目标风格档案。
- 输出：迁移稿 + 偏移说明。

`/风格库检索`
- 功能：检索可复用风格档案并排序推荐。
- 何时使用：新题材开书或选风格困难时。
- 输入：题材、目标效果。
- 输出：候选风格列表 + 优先级建议。

`/检索记忆`
- 功能：按关键词搜索记忆系统信息。
- 何时使用：定位历史伏笔、设定或角色状态。
- 输入：关键词。
- 输出：相关记忆文件命中与摘要。

`/伏笔状态`
- 功能：查看伏笔埋设、回收、超期状态。
- 何时使用：写作前确认伏笔债务。
- 输入：可选过滤条件（角色/章节范围/紧急度）。
- 输出：伏笔状态报告与优先回收建议。

`/角色状态`
- 功能：汇总角色当前状态与近期变化。
- 何时使用：人物关系复杂或群像章节前。
- 输入：可选角色名/章节范围。
- 输出：角色状态报告（目标/位置/关系/能力变化）。

`/时间线`
- 功能：查看并校验事件时间顺序。
- 何时使用：跨章节跳时、回忆、并行线叙事场景。
- 输入：可选时间段/角色/事件类型。
- 输出：时间线报告与潜在冲突提示。

`/完整流程`（兼容入口）
- 功能：串联“拆书→仿写→建库→写作→门禁闭环”。
- 何时使用：希望一次性跑通全链路。
- 输入：项目基础信息 + 样章（可选）。
- 输出：全流程执行计划与阶段产物。

`/安装到多工具`
- 功能：把本技能安装到 Codex、Claude Code、OpenCode、Gemini CLI、Antigravity。
- 何时使用：首次安装或升级技能版本时。
- 输入：目标工具名（可选，默认当前工具）。
- 输出：目标工具技能目录与入口文件。
